# ==============================================================
# Azure DevOps Pipeline: .NET CI with Code Quality Checks
# ==============================================================

trigger:
  branches:
    include:
      - main
      - dev
      - ndev
  paths:
    exclude:
      - README.md
      - "**/*.md"

pr:
  branches:
    include:
      - main
      - dev
  paths:
    exclude:
      - README.md
      - "**/*.md"

pool:
  vmImage: "windows-latest"

variables:
  buildConfiguration: "Release"
  dotnetVersion: "8.x"

jobs:
  - job: BuildAndValidate
    displayName: ".NET CI with Quality Gates"
    timeoutInMinutes: 30

    steps:
      # -----------------------------
      # 1. Checkout Code
      # -----------------------------
      - checkout: self
        clean: true

      # -----------------------------
      # 2. Install .NET SDK
      # -----------------------------
      - task: UseDotNet@2
        displayName: "Install .NET SDK"
        inputs:
          version: "$(dotnetVersion)"
          includePreviewVersions: false

      - script: dotnet --version
        displayName: "Verify .NET Version"

      # -----------------------------
      # 3. Restore Dependencies
      # -----------------------------
      - task: DotNetCoreCLI@2
        displayName: "Restore NuGet Packages"
        inputs:
          command: "restore"
          projects: "**/*.csproj"

      # -----------------------------
      # 4. Build (Release, No Style Enforcement)
      # -----------------------------
      - task: DotNetCoreCLI@2
        displayName: "Build Release"
        inputs:
          command: "build"
          arguments: >
            --configuration $(buildConfiguration)
            --no-restore
            /p:TreatWarningsAsErrors=false
          projects: "**/*.csproj"
        continueOnError: true

      # -----------------------------
      # 5. Code Style Verification
      # -----------------------------
      - script: |
          dotnet tool install -g dotnet-format || echo "dotnet-format already installed"
          dotnet format --verify-no-changes --verbosity diagnostic
        displayName: "Verify Code Formatting (.editorconfig)"
        continueOnError: true

      - task: DotNetCoreCLI@2
        displayName: "Build with Style Enforcement"
        inputs:
          command: "build"
          arguments: >
            --configuration $(buildConfiguration)
            --no-restore
            /p:EnforceCodeStyleInBuild=true
            /p:AnalysisLevel=latest-all
            /p:TreatWarningsAsErrors=false
          projects: "**/*.csproj"
        continueOnError: true

      # -----------------------------
      # 6. Run Unit Tests
      # -----------------------------
      - task: DotNetCoreCLI@2
        displayName: "Run Unit Tests"
        inputs:
          command: "test"
          arguments: >
            --configuration $(buildConfiguration)
            --no-build
            --collect:"XPlat Code Coverage"
            --logger trx
            --results-directory $(Agent.TempDirectory)/TestResults
          projects: "**/*Tests.csproj"
          publishTestResults: false
        continueOnError: true

      # -----------------------------
      # 7. Publish Test Results
      # -----------------------------
      - task: PublishTestResults@2
        displayName: "Publish Test Results"
        condition: always()
        inputs:
          testResultsFormat: "VSTest"
          testResultsFiles: "$(Agent.TempDirectory)/TestResults/**/*.trx"
          mergeTestResults: true
          failTaskOnFailedTests: false

      # -----------------------------
      # 8. Publish Code Coverage
      # -----------------------------
      - task: PublishCodeCoverageResults@1
        displayName: "Publish Code Coverage"
        condition: always()
        inputs:
          codeCoverageTool: "Cobertura"
          summaryFileLocation: "$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml"
          failIfCoverageEmpty: false

      # -----------------------------
      # 9. Publish Application (Only if Build Succeeded)
      # -----------------------------
      - task: DotNetCoreCLI@2
        displayName: "Publish Application"
        condition: succeeded()
        inputs:
          command: "publish"
          arguments: >
            --configuration $(buildConfiguration)
            --output $(Build.ArtifactStagingDirectory)/app
            --no-build
          projects: "**/*.csproj"
          publishWebProjects: false
          zipAfterPublish: true

      # -----------------------------
      # 10. Publish Build Artifacts
      # -----------------------------
      - task: PublishBuildArtifacts@1
        displayName: "Publish Build Artifacts"
        condition: succeeded()
        inputs:
          pathToPublish: "$(Build.ArtifactStagingDirectory)"
          artifactName: "dotnet-build-artifacts"
          publishLocation: "Container"

      # -----------------------------
      # 11. Build Summary
      # -----------------------------
      - script: |
          echo "##[section]‚úÖ Pipeline Execution Summary"
          echo "‚úÖ Build completed (Release)"
          echo "‚úÖ Code style checks executed"
          echo "‚úÖ Unit tests executed"
          echo "‚úÖ Code coverage reports generated"
          echo ""
          echo "üìä Check Azure DevOps tabs for:"
          echo "  - Test Results"
          echo "  - Code Coverage Report"
          echo "  - Build Artifacts"
          echo ""
          echo "‚ö†Ô∏è  Note: Steps configured with continueOnError will not fail the pipeline"
        displayName: "Display Build Summary"
        condition: always()
