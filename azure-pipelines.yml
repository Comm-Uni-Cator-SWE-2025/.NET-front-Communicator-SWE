# ==============================================================
# Azure DevOps Pipeline: .NET CI (Build, Tests, Coverage, Artifacts)
# ==============================================================

trigger:
  branches:
    include:
      - main
      - dev
      - ndev
  paths:
    exclude:
      - README.md
      - "**/*.md"

pr:
  branches:
    include:
      - main
      - dev
  paths:
    exclude:
      - README.md
      - "**/*.md"

pool:
  vmImage: "windows-latest"

variables:
  buildConfiguration: "Release"
  dotnetVersion: "8.x"

jobs:
  - job: BuildAndValidate
    displayName: ".NET CI without Style-Enforced Build"
    timeoutInMinutes: 30

    steps:
      - checkout: self
        clean: true

      - task: UseDotNet@2
        displayName: "Install .NET SDK"
        inputs:
          version: "$(dotnetVersion)"
          includePreviewVersions: false

      - script: dotnet --version
        displayName: "Verify .NET Version"

      - task: DotNetCoreCLI@2
        displayName: "Restore NuGet Packages"
        inputs:
          command: "restore"
          projects: "**/*.csproj"

      # ------------------------------------------------
      # Build only (Release), no code-style enforcement,
      # warnings are allowed
      # ------------------------------------------------
      - task: DotNetCoreCLI@2
        displayName: "Build - Release (Ignore Warnings)"
        inputs:
          command: "build"
          arguments: >
            --configuration $(buildConfiguration)
            --no-restore
          projects: "**/*.csproj"

      # ------------------------------------------------
      # Code formatting / style check (non-blocking)
      # Fails the task, but rest of pipeline still runs
      # ------------------------------------------------
      - script: |
          dotnet tool install -g dotnet-format || true
          dotnet format --verify-no-changes --verbosity minimal
        displayName: "Verify Code Formatting (.editorconfig)"
        continueOnError: true

      # ------------------------------------------------
      # Unit tests with coverage
      # Always try to run, even if build/format failed
      # ------------------------------------------------
      - task: DotNetCoreCLI@2
        displayName: "Run Unit Tests with Coverage"
        condition: always()
        inputs:
          command: "test"
          arguments: >
            --configuration $(buildConfiguration)
            --no-build
            --collect:"XPlat Code Coverage"
            --logger trx
            --results-directory $(Agent.TempDirectory)/TestResults
          projects: "**/*Tests.csproj"
          publishTestResults: false

      - task: PublishTestResults@2
        displayName: "Publish Test Results"
        condition: always()
        inputs:
          testResultsFormat: "VSTest"
          testResultsFiles: "$(Agent.TempDirectory)/TestResults/**/*.trx"
          mergeTestResults: true
          failTaskOnFailedTests: true

      - task: PublishCodeCoverageResults@1
        displayName: "Publish Code Coverage"
        condition: always()
        inputs:
          codeCoverageTool: "Cobertura"
          summaryFileLocation: "$(Agent.TempDirectory)/TestResults/**/coverage.cobertura.xml"
          failIfCoverageEmpty: false

      # ------------------------------------------------
      # Publish only if build actually succeeded
      # (no-style build above must be green)
      # ------------------------------------------------
      - task: DotNetCoreCLI@2
        displayName: "Publish Application"
        condition: succeeded('BuildAndValidate')
        inputs:
          command: "publish"
          arguments: >
            --configuration $(buildConfiguration)
            --output $(Build.ArtifactStagingDirectory)/app
            --no-build
          projects: "**/*.csproj"
          publishWebProjects: false
          zipAfterPublish: true

      - task: PublishBuildArtifacts@1
        displayName: "Publish Build Artifacts"
        condition: succeeded('BuildAndValidate')
        inputs:
          pathToPublish: "$(Build.ArtifactStagingDirectory)"
          artifactName: "dotnet-build-artifacts"
          publishLocation: "Container"

      - script: |
          echo "##[section]Build Summary"
          echo "• Build (Release) completed - style not enforced in build"
          echo "• Code formatting checked (.editorconfig) - non-blocking"
          echo "• Tests executed with coverage (run even if previous steps failed)"
          echo "• Artifacts published only if build succeeded"
          echo ""
          echo "Check Azure DevOps tabs for:"
          echo "  - Test Results"
          echo "  - Code Coverage Report"
          echo "  - Build Artifacts"
        displayName: "Display Build Summary"
        condition: always()
