<UserControl x:Class="Communicator.App.Views.Meeting.ChatView" x:ClassModifier="public"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:icons="clr-namespace:Communicator.Icons;assembly=Communicator.Icons"
             xmlns:chatConverters="clr-namespace:Communicator.Chat;assembly=Communicator.Chat"
             mc:Ignorable="d"
             d:DesignHeight="600"
             d:DesignWidth="400"
             Background="{DynamicResource AppBackgroundBrush}">
    
    <UserControl.Resources>
        <!-- Chat Converters -->
        <chatConverters:FileSizeConverter x:Key="FileSizeConverter"/>

        <!-- Message Bubble Style -->
        <Style x:Key="MessageBubbleStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="MaxWidth" Value="320"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSentByMe}" Value="True">
                    <Setter Property="Background" Value="{DynamicResource PrimaryBrush}"/>
                    <Setter Property="HorizontalAlignment" Value="Right"/>
                    <Setter Property="TextElement.Foreground" Value="{DynamicResource TextOnPrimaryBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsSentByMe}" Value="False">
                    <Setter Property="Background" Value="{DynamicResource CardBackgroundBrush}"/>
                    <Setter Property="HorizontalAlignment" Value="Left"/>
                    <Setter Property="TextElement.Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <!-- Quote Border Style -->
        <Style x:Key="QuoteBorderStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
            <Setter Property="BorderThickness" Value="2,0,0,0"/>
            <Setter Property="BorderBrush" Value="{DynamicResource PrimaryBrush}"/>
            <Setter Property="TextElement.Foreground" Value="{DynamicResource TextPrimaryBrush}"/>
            
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsSentByMe}" Value="True">
                    <Setter Property="Background" Value="{DynamicResource PrimaryLightBrush}"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding IsSentByMe}" Value="False">
                    <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Messages List -->
        <ScrollViewer Grid.Row="0" 
                      VerticalScrollBarVisibility="Auto"
                      Padding="12"
                      Background="{DynamicResource AppBackgroundBrush}">
            <ItemsControl ItemsSource="{Binding Messages}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Grid Margin="4,2">
                            <Border Style="{StaticResource MessageBubbleStyle}">
                                <StackPanel>
                                    <!-- Username -->
                                    <TextBlock Text="{Binding Username}"
                                               FontSize="12"
                                               FontWeight="SemiBold"
                                               Opacity="0.9"
                                               Margin="0,0,0,4"/>

                                    <!-- Quoted Message (if replying) -->
                                    <Border Visibility="{Binding HasQuote, Converter={StaticResource BooleanToVisibilityConverter}}"
                                            Style="{StaticResource QuoteBorderStyle}">
                                        <StackPanel Orientation="Horizontal">
                                            <icons:Icon IconName="corner-up-left" 
                                                        IconSize="12" 
                                                        Opacity="0.7"
                                                        Margin="0,0,6,0"
                                                        VerticalAlignment="Top"/>
                                            <TextBlock Text="{Binding QuotedContent}"
                                                       FontSize="11"
                                                       FontStyle="Italic"
                                                       Opacity="0.7"
                                                       TextWrapping="Wrap"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- File Message -->
                                    <Border Visibility="{Binding IsFileMessage, Converter={StaticResource BooleanToVisibilityConverter}}"
                                            Background="{DynamicResource SurfaceBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="6"
                                            Padding="10,8"
                                            Margin="0,0,0,8"
                                            TextElement.Foreground="{DynamicResource TextPrimaryBrush}">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            
                                            <icons:Icon Grid.Column="0"
                                                        IconName="file" 
                                                        IconSize="20" 
                                                        Margin="0,0,10,0"
                                                        VerticalAlignment="Center"/>
                                            
                                            <StackPanel Grid.Column="1">
                                                <TextBlock Text="{Binding FileName}"
                                                           FontSize="12"
                                                           FontWeight="SemiBold"
                                                           TextTrimming="CharacterEllipsis"
                                                           Margin="0,0,0,2"/>
                                                <TextBlock Text="{Binding CompressedFileSize, Converter={StaticResource FileSizeConverter}}"
                                                           FontSize="10"
                                                           Opacity="0.7"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>

                                    <!-- Text Content -->
                                    <TextBlock Text="{Binding Content}"
                                               FontSize="13"
                                               TextWrapping="Wrap"
                                               Visibility="{Binding Content, Converter={StaticResource StringToVisibilityConverter}}"/>

                                    <!-- Timestamp and Actions Row -->
                                    <Grid Margin="0,8,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <!-- Timestamp -->
                                        <TextBlock Grid.Column="0"
                                                   Text="{Binding Timestamp}"
                                                   FontSize="10"
                                                   Opacity="0.6"
                                                   VerticalAlignment="Center"/>

                                        <!-- Action Buttons -->
                                        <StackPanel Grid.Column="1" 
                                                    Orientation="Horizontal">
                                            <!-- Reply Button -->
                                            <Button Command="{Binding DataContext.StartReplyCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Reply"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4"
                                                    Margin="0,0,4,0"
                                                    Cursor="Hand">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}"
                                                                            Padding="{TemplateBinding Padding}"
                                                                            CornerRadius="4">
                                                                        <ContentPresenter/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background">
                                                                    <Setter.Value>
                                                                        <SolidColorBrush Color="White" Opacity="0.2"/>
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <icons:Icon IconName="corner-up-left" 
                                                            IconSize="14" 
                                                            Opacity="0.8"/>
                                            </Button>

                                            <!-- Download File Button (for file messages) -->
                                            <Button Command="{Binding DataContext.DownloadFileCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Download File"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4"
                                                    Margin="0,0,4,0"
                                                    Cursor="Hand"
                                                    Visibility="{Binding IsFileMessage, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}"
                                                                            Padding="{TemplateBinding Padding}"
                                                                            CornerRadius="4">
                                                                        <ContentPresenter/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background">
                                                                    <Setter.Value>
                                                                        <SolidColorBrush Color="White" Opacity="0.2"/>
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <icons:Icon IconName="download" 
                                                            IconSize="14" 
                                                            Opacity="0.8"/>
                                            </Button>

                                            <!-- Delete Button (only for own messages) -->
                                            <Button Command="{Binding DataContext.DeleteMessageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                    CommandParameter="{Binding}"
                                                    ToolTip="Delete Message"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4"
                                                    Cursor="Hand"
                                                    Visibility="{Binding IsSentByMe, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                <Button.Style>
                                                    <Style TargetType="Button">
                                                        <Setter Property="Background" Value="Transparent"/>
                                                        <Setter Property="Template">
                                                            <Setter.Value>
                                                                <ControlTemplate TargetType="Button">
                                                                    <Border Background="{TemplateBinding Background}"
                                                                            Padding="{TemplateBinding Padding}"
                                                                            CornerRadius="4">
                                                                        <ContentPresenter/>
                                                                    </Border>
                                                                </ControlTemplate>
                                                            </Setter.Value>
                                                        </Setter>
                                                        <Style.Triggers>
                                                            <Trigger Property="IsMouseOver" Value="True">
                                                                <Setter Property="Background">
                                                                    <Setter.Value>
                                                                        <SolidColorBrush Color="White" Opacity="0.2"/>
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </Trigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                                <icons:Icon IconName="trash" 
                                                            IconSize="14" 
                                                            Opacity="0.9"/>
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Reply Indicator -->
        <Border Grid.Row="1"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="12,10"
                Visibility="{Binding IsReplying, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <icons:Icon Grid.Column="0"
                            IconName="corner-up-left" 
                            IconSize="18" 
                            Foreground="{DynamicResource PrimaryBrush}"
                            Margin="0,0,10,0"
                            VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1"
                           Text="{Binding ReplyQuoteText}"
                           FontSize="12"
                           FontStyle="Italic"
                           Foreground="{DynamicResource TextSecondaryBrush}"
                           TextTrimming="CharacterEllipsis"
                           VerticalAlignment="Center"/>

                <Button Grid.Column="2"
                        Command="{Binding CancelReplyCommand}"
                        ToolTip="Cancel Reply"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="6"
                        Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}"
                                                Padding="{TemplateBinding Padding}"
                                                CornerRadius="4">
                                            <ContentPresenter/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <icons:Icon IconName="x" 
                                IconSize="16" 
                                Foreground="{DynamicResource IconBrush}"/>
                </Button>
            </Grid>
        </Border>

        <!-- Attachment Indicator -->
        <Border Grid.Row="1"
                Background="{DynamicResource SurfaceBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="12,10"
                Visibility="{Binding HasAttachment, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <icons:Icon Grid.Column="0"
                            IconName="paperclip" 
                            IconSize="18" 
                            Foreground="{DynamicResource PrimaryBrush}"
                            Margin="0,0,10,0"
                            VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1"
                           Text="{Binding AttachmentText}"
                           FontSize="12"
                           Foreground="{DynamicResource TextPrimaryBrush}"
                           TextTrimming="CharacterEllipsis"
                           VerticalAlignment="Center"/>

                <Button Grid.Column="2"
                        Command="{Binding CancelAttachmentCommand}"
                        ToolTip="Cancel Attachment"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="6"
                        Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}"
                                                Padding="{TemplateBinding Padding}"
                                                CornerRadius="4">
                                            <ContentPresenter/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <icons:Icon IconName="x" 
                                IconSize="16" 
                                Foreground="{DynamicResource IconBrush}"/>
                </Button>
            </Grid>
        </Border>

        <!-- Input Box -->
        <Border Grid.Row="2"
                Background="{DynamicResource CardBackgroundBrush}"
                BorderBrush="{DynamicResource BorderBrush}"
                BorderThickness="0,1,0,0"
                Padding="12,10"
                SnapsToDevicePixels="True">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Attach File Button -->
                <Button Grid.Column="0"
                        Command="{Binding AttachFileCommand}"
                        ToolTip="Attach File"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="8"
                        Margin="0,0,6,0"
                        Cursor="Hand"
                        VerticalAlignment="Center">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="{TemplateBinding Background}"
                                                Padding="{TemplateBinding Padding}"
                                                CornerRadius="6">
                                            <ContentPresenter/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                            <Style.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="{DynamicResource HoverBackgroundBrush}"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                    <icons:Icon IconName="paperclip" 
                                IconSize="20" 
                                Foreground="{DynamicResource IconBrush}"/>
                </Button>

                <!-- Text Input -->
                <TextBox Grid.Column="1"
                         Text="{Binding MessageInput, UpdateSourceTrigger=PropertyChanged}"
                         FontSize="14"
                         Foreground="{DynamicResource TextPrimaryBrush}"
                         Background="{DynamicResource SurfaceBrush}"
                         BorderBrush="{DynamicResource BorderBrush}"
                         BorderThickness="1"
                         Padding="10,8"
                         VerticalAlignment="Center"
                         TextWrapping="Wrap"
                         MaxHeight="100"
                         AcceptsReturn="False"
                         VerticalContentAlignment="Center">
                    <TextBox.Style>
                        <Style TargetType="TextBox" BasedOn="{StaticResource TextBoxStyle}">
                            <Setter Property="CaretBrush" Value="{DynamicResource PrimaryBrush}"/>
                        </Style>
                    </TextBox.Style>
                    <TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding SendMessageCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>

                <!-- Send Button -->
                <Button Grid.Column="2"
                        Command="{Binding SendMessageCommand}"
                        ToolTip="Send Message"
                        Style="{StaticResource PrimaryButtonStyle}"
                        Padding="12,8"
                        Margin="6,0,0,0"
                        VerticalAlignment="Center"
                        Cursor="Hand">
                    <icons:Icon IconName="send" 
                                IconSize="20" 
                                Foreground="{DynamicResource TextOnPrimaryBrush}"/>
                </Button>
            </Grid>
        </Border>
    </Grid>
</UserControl>

